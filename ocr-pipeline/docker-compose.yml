version: '3.8'

services:
  # Ollama LLM Service
  ollama:
    image: ollama/ollama:latest
    container_name: driftmoney-ollama
    expose:
      - "11434"
    volumes:
      - ollama_data:/root/.ollama
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # Surya OCR Service
  surya-ocr:
    build:
      context: ./surya-service
      dockerfile: Dockerfile
    container_name: driftmoney-surya
    expose:
      - "8001"
    volumes:
      - ./uploads:/app/uploads
    restart: unless-stopped

  # Pipeline API Service
  api:
    build:
      context: ./api-service
      dockerfile: Dockerfile
    container_name: driftmoney-ocr-api
    expose:
      - "8000"
    volumes:
      - ./uploads:/app/uploads
    environment:
      - OLLAMA_URL=http://ollama:11434
      - SURYA_URL=http://surya-ocr:8001
      - LLM_MODEL=${LLM_MODEL:-llama3.1:8b}
    depends_on:
      - surya-ocr
      - ollama
    restart: unless-stopped

  # Caddy Reverse Proxy
  caddy:
    image: caddy:2
    container_name: driftmoney-caddy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - api
      - ollama
    restart: unless-stopped

volumes:
  ollama_data:
  caddy_data:
  caddy_config:
